<p>Graphing with Django and Plotly is a powerful combination for creating interactive and visually
appealing graphs on the web. In this blog post, we will explore how to set up a Django project
for graphing. I will cover using either <i><a href="https://plotly.com/javascript/" target="blank">Plotly.js</a></i>
in the browser or generating graphs with <i><a href="https://plotly.com/javascript/" target="blank">Plotly.py</a></i>
on the backend. By the end of this post,
you will have a solid understanding of how to use Django and Plotly together to create
graphs for your web applications.</p>

<div class="iframe-container">
    <iframe class="responsive-iframe" src="https://www.youtube.com/embed/w3TI7pqWIC4">
    </iframe>
</div>

<div style="height: 30px;">
    <div
        onclick="window.location='https://github.com/claytoncook12/Plotly_DJ_Blog_Post'"
        class="w3-green w3-hover-shadow w3-right"
        style="font-size: 12px; cursor: pointer; max-width: 200px; border-radius: 10px; padding: 10px; margin: 10px;"
        >
            Full Code on Github
    </div>
</div>


<br>
<h2>Setting Up the Django Project</h2>
<p>
    <ul>
        <li>Installing necessary dependencies</li>
        <ul>
            <li><code>pip install django plotly</code></li>
        </ul>
        <li>Creating a new Django project.</li>
        <ul>
            <li><code>django-admin startproject core</code></li>
            <li>Rename core folder to DjangoApp</li>
            <li>Create App, <code>py manage.py startapp base</code></li>
            <li>Add app to <kbd>settings.py</kbd></li>
        </ul>
        
    </ul>    
</p>

<h2>Creating Models And Importing Data</h2>
<ul>
    <li>Defining Django models to store data for graphing in <kbd>'base\models.py'</kbd></li>
        <ul>
            <p>We will be creating a model that represents population data for counties located
                in Kentucky, United States. See model class definition below.</p>
            </p>

            <p>
                <pre><code class="language-py"># base/models.py
from django.db import models

# Create your models here.
class Population(models.Model):
state = models.CharField(max_length=50)
county = models.CharField(max_length=50)
pop2020 = models.IntegerField('Population in 2020')
pop2024 = models.IntegerField('Population in 2024')
areaMi = models.FloatField("Area in square miles")
density = models.FloatField("Calculated density of population per square mile")
growthSince2020 = models.FloatField("Growth since 2020")

def __str__(self):
return self.county</code></pre>
            </p>
        </ul>
    <li>Defining Django Admin models to display data for admin in <kbd>'base\admin.py'</kbd></li>
    <ul>
        <p>We will be creating a model admin class that will display the population data in the
            Django admin interface. See model admin class definition below.</p>
        <p>
            <pre><code class="language-py"># base/admin.py
from django.contrib import admin
from .models import Population

# Register your models here.
@admin.register(Population)
class PopulationAdmin(admin.ModelAdmin):
list_display = ('county',)
ordering = ('county',)
search_fields = ('county',)</code></pre>
        </p>
    </ul>
    <li>Running migrations to create database tables. 
        <code>python manage.py makemigrations</code> & 
        <code>python manage.py migrate</code>
    </li>
    <li>Create an Admin 
        <code>python manage.py createsuperuser</code>
    </li>
    <li>Creating fixtures with data in <kbd>'base\fixtures\mydata.json'</kbd></li>
        <ul>
            <p>I created this fixtures in json format after importing data into my database
                from a csv file. Fixtures are useful for importing data
                into the database for testing or seeding data. The file 
                has data from all 120 counties in Kentucky. See snippet of the fixture below.</p>
            </p>

            <p>
                <pre><code class="language-json"># base/fixtures/mydata.json
[
    {
        "model": "base.population",
        "pk": 1,
        "fields": {
        "state": "Kentucky",
        "county": "Jefferson County",
        "pop2020": 782845,
        "pop2024": 771193,
        "areaMi": 381.0,
        "density": 2024.1286089238845,
        "growthSince2020": -0.0148841724734781
    }
    },
    {
        "model": "base.population",
        "pk": 2,
        "fields": {
...</code></pre>
            </p>
        </ul>
    <li>Importing fixtures with data. <code>py manage.py loaddata mydata</code></li>
    <li>Verify that the data was import correctly with the admin interface.</li>
</ul>

<h2>Building the Backend with Django For Chart Generation</h2>
<ul>
    <li>Add <kbd>base.urls.py</kbd> to <kbd>urls.py</kbd></li>
    <ul>
        <p>
            <pre><code class="language-py"># base/urls.py
from django.urls import path

from . import views

urlpatterns = [
path("", views.index, name="index")
]</code></pre>
        </p>
        <p>
            <pre><code class="language-py"># core/urls.py
from django.contrib import admin
from django.urls import include, path

urlpatterns = [
path('admin/', admin.site.urls),
path('', include('base.urls')),
]</code></pre>
        </p>
    </ul>
    <li>Creating views to handle data processing and graph generation.</li>
    <ul>
        <li>Creating view in <kbd>'base\views.py'</kbd></li>
            <p>
                <pre><code class="language-py"># base/views.py
from django.shortcuts import render
from base.models import Population
from base.graphs import histogram_plot_pop, histogram_plot_pop_change

# Create your views here.
def index(request):

# Get the population data
county_pop = Population.objects.all() #<- for backend processing
county_pop_json = list(Population.objects.values()) #<- for frontend consumption

# Backend Histogram Plots
pop_hist_2024 = histogram_plot_pop(county_pop)
pop_hist_change_2024 = histogram_plot_pop_change(county_pop)

return render(request, "base/index.html", {
"county_pop": county_pop,
"county_pop_json": county_pop_json,
"pop_hist_2024": pop_hist_2024,
"pop_hist_change_2024": pop_hist_change_2024
})</code></pre>
            </p>
    
        <li>
            <p>You can see from <kbd>base/views.py</kbd> above that we have a variable <kdb>county_pop_json</kdb>
            that will be used for front end javascript consumption and two functions that generate
            histograms for population data that we have not created yet. These functions will be defined in <kbd>base/graphs.py</kbd>.
            </p>
        </li>
    </ul>
</ul>

<h2>Plotly with the Backend</h2>
    <ul>
        <li>Creating the two functions for backend graph creation.</li>
        <ul>
            <p>
<pre><code class="language-py"># base/graphs.py
from plotly.offline import plot
from plotly.graph_objs import Histogram, Layout
from plotly.graph_objs.layout import XAxis, YAxis
from base.models import Population

def histogram_plot_pop(population: Population) -> str:
    if population.count() == 0:
        return "No data to plot"
    
    x_data = list(population.values_list("pop2024", flat=True))

    # Create a histogram
    trace = Histogram(
        x=x_data,
        opacity=0.7,
        xbins=dict(size=10000)
    )

    plotly_html = plot({
        "data": [trace],
        "layout": Layout(
            title="Kentucky Counties 2024 Population Histogram",
            bargap=0.1,
            yaxis=YAxis(
                title="Count",

                gridcolor="#b0b0b0",
            ),
            xaxis=XAxis(
                title="Population"
            ),
            paper_bgcolor='rgba(0,0,0,0)',
            plot_bgcolor='rgba(0,0,0,0)'
        )
    }, 
    output_type="div",
    include_plotlyjs=False)

    return plotly_html

def histogram_plot_pop_change(population: Population) -> str:
    if population.count() == 0:
        return "No data to plot"
    
    x_data = list(population.values_list("growthSince2020", flat=True))
    x_data_percent = [x * 100 for x in x_data ]

    # Create a histogram
    trace = Histogram(
        x=x_data_percent,
        opacity=0.7
    )

    plotly_html = plot({
        "data": [trace],
        "layout": Layout(
            title="Kentucky Counties 2024 Population Change Histogram",
            bargap=0.1,
            yaxis=YAxis(
                title="Count",

                gridcolor="#b0b0b0",
            ),
            xaxis=XAxis(
                title="Population Change (%)"
            ),
            paper_bgcolor='rgba(0,0,0,0)',
            plot_bgcolor='rgba(0,0,0,0)'
        )
    }, 
    output_type="div",
    include_plotlyjs=False)

    return plotly_html</code></pre>
            </p>
        </ul>
        <li>
            <p>Passing graph html code to front end through the <kdb>pop_hist_2024</kdb>
            and <kdb>pop_hist_change_2024</kdb> variables. Then displaying that in 
            the <kdb>index.html</kdb> file.
            </p>

            <pre><code class="language-html"># base/templates/index.html
... 
<article id="backend__graphs">
{% autoescape off %}
    {{ pop_hist_2024 }}
{% endautoescape %}
{% autoescape off %}
    {{ pop_hist_change_2024 }}
{% endautoescape %}
</article>
...</code></pre>
        </li>
    </ul>

<h2>Plotly with the Frontend</h2>
<ul>
    <li>
        In order to use Plotly.js on the front end you will need 
        <code>&lt;script src="https://cdn.plot.ly/plotly-3.0.0.min.js" charset="utf-8"&gt;&lt;/script&gt;</code>
        in the head of your html file.
    </li>
    <li>
        Next up is creating the templates for that graph creation. I like to separate out these into 
        a sub template, <code>'base\templates\base\partials\index_county_pop.html'</code>.
    </li>
    <li>
        We can then convert our <code>county_pop_json</code> variable from the <code>view.py</code> file into json data
        that can be consumed by our javascript code.

        <p>
        <pre><code class="language-html">
&lt;div id="plot_001"&gt;&lt;/div&gt;
&lt;div id="plot_002"&gt;&lt;/div&gt;

{{ county_pop_json|json_script:"county_pop_json" }} <- this line converts the data to json

&lt;script type="text/javascript" defer&gt;
// This reads the JSON data
const data = JSON.parse(document.getElementById('county_pop_json').textContent);
	
// Histogram Plot County Population 2024
canvas_001 = document.getElementById('plot_001');
const trace_001 = {
    x: [...data.map((county) => county.pop2020)],
    type: 'histogram',
    opacity: 0.7,
    xbins: {size: 10000}
};
const layout_001 = {
    bargap: 0.1,
    title: {
        text: "Kentucky Counties 2024 Population Histogram",
    },
    xaxis: { title: {'text': 'Population'}},
    yaxis: { title: {'text':'Count'}},
};
Plotly.newPlot(canvas_001, [trace_001], layout_001);

// Histogram Plot County Population Change 2024
canvas_002 = document.getElementById('plot_002');
const trace_002 = {
    x: [...data.map((county) => (county.growthSince2020) * 100)],
    type: 'histogram',
    opacity: 0.7
};
const layout_002 = {
    bargap: 0.05,
    title: {
        text: "Kentucky Counties 2024 Population Change Histogram",
    },
    xaxis: { title: {'text': 'Population Change (%)'}},
    yaxis: { title: {'text':'Count'}},
};
Plotly.newPlot(canvas_002, [trace_002], layout_002);
&lt;/script&gt</code></pre>
        </p>
    </li>
    <li>Now you can add <code>{% include "base/partials/index_county_pop.html" with county_pop_json=county_pop_json %}</code>
    into your <cbd>index.html</cbd> to include the plotly.js graphs.</li>
</ul>

<h2>Looks of the Browser</h2>
<div class="w3-container  w3-center w3-padding-small">
    <img 
        class="w3-image"
        src="../static/images/graphs_django_plotly_screenshot.jpeg"
        alt="picture">
    <figcaption class="w3-center">
        <b>Figure: Graphs in the Browser</b>
    </figcaption>
</div>
<p>
    After all of this work, you should have a Django project that can display population data in
    plotly generated histograms. The front end will display the histograms in the browser
    using Plotly.js or you can create the same graphs with Plotly.py on the backend.
    This is a powerful combination that can be used to create interactive and visually
    appealing graphs for your web applications.
</p>

<h2>Pros and Cons of Plotly.js vs. Plotly.py</h2>
<p id="pro_cons">
    Using Plotly.js provides highly interactive graphs that can be manipulated directly in the browser,
    reducing server load by handling rendering on the client side and integrating well with various frontend
    frameworks. However, it requires knowledge of JavaScript, raises potential data privacy concerns due to
    client-side data handling, and may involve more complex setup. On the other hand, Plotly.py allows
    developers to stay within the Python ecosystem, processes data on the server side for better control
    over sensitive information, and can be simpler to set up within a Python environment. Despite these
    advantages, Plotly.py might not offer the same level of interactivity and responsiveness as Plotly.js,
    and it can increase server load with many users generating graphs simultaneously. Ultimately, the
    choice between Plotly.js and Plotly.py depends on the specific needs of the project.
</p>

<h2>Further Resources</h2>
<ul>
    <li><a href="https://www.youtube.com/watch?v=h39eMGWmEV4" target="_blank">
        BugBytes - Passing Backend Data to JavaScript
    </a></li>
    <li><a href="https://adamj.eu/tech/2020/02/18/safely-including-data-for-javascript-in-a-django-template/" target="_blank">
        Adam Johnson - Django: safely include data for JavaScript in templates
    </a></li>
</ul>